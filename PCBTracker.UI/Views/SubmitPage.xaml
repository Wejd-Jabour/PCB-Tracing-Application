<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="PCBTracker.UI.Views.SubmitPage"
    x:Name="SubmitPageRoot"
    Title="Submit a Board">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="15">
            <Label Text="Submit Board" FontSize="24" HorizontalOptions="Center" />
            <HorizontalStackLayout
                Margin="0,4,0,0"
                Spacing="10"
                IsVisible="{Binding IsWorkingOnOrder}">
                            <Label
                    Text="{Binding WorkingOnOrderLabel}"
                    TextColor="Blue"
                    FontAttributes="Italic"
                    VerticalOptions="Center" />
                            <Button
                    Text="Cancel"
                    Command="{Binding CancelWorkingOnOrderCommand}"
                    VerticalOptions="Center" />
                        </HorizontalStackLayout>

            <Picker
                x:Name="BoardTypePicker"
                Title="Board Type"
                ItemsSource="{Binding BoardTypes}"
                SelectedItem="{Binding SelectedBoardType}"
                IsEnabled="{Binding CanEditBoardDetails}" />

            <Entry
                IsVisible="{Binding IsCreatingNewType}"
                Placeholder="Enter new board type"
                Text="{Binding NewBoardTypeText}"
                IsEnabled="{Binding CanEditBoardDetails}" />

            <Entry
                x:Name="SerialNumberEntry"
                Placeholder="Serial Number"
                Text="{Binding SerialNumber}"
                Completed="OnSerialNumberEntryCompleted"
                IsEnabled="{Binding IsSkidLocked, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}" />

            <Entry
                x:Name="PartNumberEntry"
                Placeholder="Part Number"
                Text="{Binding PartNumber}"
                IsEnabled="{Binding CanEditBoardDetails}" />

            <DatePicker
                Date="{Binding PrepDate}"
                IsEnabled="{Binding IsSkidLocked, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}" />

            <HorizontalStackLayout Spacing="10" VerticalOptions="Center">
                <Label
                  Text="Mark as Shipped"
                  VerticalOptions="Center" />
                <Switch
                  IsToggled="{Binding IsShipped}"
                  IsEnabled="{Binding IsSkidLocked, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}" />
            </HorizontalStackLayout>

            <VerticalStackLayout
                Spacing="10"
                Padding="20"
                VerticalOptions="Center"
                HorizontalOptions="Start">

                <!-- Top row: arrows + picker, left-aligned -->
                <HorizontalStackLayout
                  Spacing="10"
                  HorizontalOptions="Start">
                    <Button
                      Text="‹"
                      Command="{Binding PageBackwardCommand}"
                      WidthRequest="50"
                      HeightRequest="50" />

                    <Picker
                      Title="Skid"
                      ItemsSource="{Binding Skids}"
                      SelectedItem="{Binding SelectedSkid}"
                      ItemDisplayBinding="{Binding SkidName}"
                      WidthRequest="200" />

                    <Button
                      Text="›"
                      Command="{Binding PageForwardCommand}"
                      WidthRequest="50"
                      HeightRequest="50" />
                </HorizontalStackLayout>

                <Label Text="This skid is for:" VerticalOptions="Center" HorizontalOptions="Center"/>
                <Label Text="{Binding CurrentSkidType}"
                       FontAttributes="Bold"
                       VerticalOptions="Center"
                       HorizontalOptions="Center" />

                <!-- Skid count -->
                <Label Text="{Binding SkidBoardCountLabel}"
                       FontAttributes="Bold"
                       HorizontalOptions="Center"
                       VerticalOptions="Center" />

                <!-- Renamed button + new command -->
                <Button
                    Text="Confirm Skid"
                    Command="{Binding OpenConfirmSkidCommand}"
                    WidthRequest="200"
                    HeightRequest="50" />
            </VerticalStackLayout>

            <Label Text="Auto Submit"
                    FontAttributes="Bold"/>
            <Switch
                IsToggled="{Binding AutoSubmitEnabled}"
                />

            <!-- Submit is disabled while locked -->
            <Button
                x:Name="SubmitButton"
                Text="Submit"
                Command="{Binding SubmitCommand}"
                Padding="20"
                Margin="30"
                Clicked="OnSubmitClicked"
                IsEnabled="{Binding IsSkidLocked, Converter={StaticResource InverseBoolConverter}, FallbackValue=True}" />

            <!-- Unlock hint (optional, non-blocking) -->
            <Label
                Text="This skid is locked. Select latest skid or unlock with your login password."
                TextColor="Red"
                IsVisible="{Binding IsSkidLocked}"
                HorizontalOptions="Center" />
            <Button
                Text="Unlock This Skid"
                Command="{Binding UnlockOldSkidCommand}"
                IsVisible="{Binding IsSkidLocked}"
                HorizontalOptions="Center" />


            <!-- MINI-TAB: Active Orders -->
            <Border
    Margin="0,20,0,0"
    Stroke="LightGray"
    StrokeThickness="1"
    BackgroundColor="#F5F5F5">

                <VerticalStackLayout Spacing="0">

                    <!-- Tab header -->
                    <Grid Padding="10" BackgroundColor="#E0E0E0">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <Label
                Text="Active Orders"
                FontAttributes="Bold"
                Grid.Column="0" />

                        <Label
                Text="{Binding ActiveOrdersCountLabel}"
                FontAttributes="Bold"
                Grid.Column="1" />
                    </Grid>

                    <!-- Column headings -->
                    <Grid Padding="8,4,8,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*" />
                            <!-- Order # -->
                            <ColumnDefinition Width="2*" />
                            <!-- Inventory ID -->
                            <ColumnDefinition Width="*" />
                            <!-- Qty -->
                            <ColumnDefinition Width="*" />
                            <!-- Scanned -->
                            <ColumnDefinition Width="Auto" />
                            <!-- Confirm -->
                        </Grid.ColumnDefinitions>

                        <Label Text="Order #"
           FontAttributes="Bold"
           Grid.Column="0" />
                        <Label Text="Inventory ID"
           FontAttributes="Bold"
           Grid.Column="1" />
                        <Label Text="Qty"
           FontAttributes="Bold"
           HorizontalTextAlignment="End"
           Grid.Column="2" />
                        <Label Text="Scanned"
           FontAttributes="Bold"
           HorizontalTextAlignment="End"
           Grid.Column="3" />

                        <!-- Only show this when at least one row has a Confirm button -->
                        <Label Text="Confirm"
           FontAttributes="Bold"
           Margin="8,0,0,0"
           Grid.Column="4"
           IsVisible="{Binding HasConfirmableOrders}" />
                    </Grid>

                    <!-- Tab content -->
                    <CollectionView
            x:Name="ActiveOrdersCollectionView"
            ItemsSource="{Binding ActiveOrders}"
            SelectedItem="{Binding SelectedActiveOrder}"
            SelectionMode="Single"
            HeightRequest="160">

                        <CollectionView.EmptyView>
                            <Label Text="No active orders."
                       Padding="10" />
                        </CollectionView.EmptyView>

                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="2*" />
                                        <ColumnDefinition Width="2*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <!-- Order number -->
                                    <Label Text="{Binding OrderNbr}"
                               Grid.Column="0" />

                                    <!-- Inventory ID -->
                                    <Label Text="{Binding InventoryId}"
                               Grid.Column="1" />

                                    <!-- Quantity (OrderQty) -->
                                    <Label Text="{Binding OrderQty}"
                               Grid.Column="2"
                               HorizontalTextAlignment="End" />

                                    <!-- Scanned counter -->
                                    <Label Text="{Binding ScannedQty}"
                               Grid.Column="3"
                               HorizontalTextAlignment="End" />

                                    <!-- Confirm button: only when ScannedQty >= OrderQty -->
                                    <Button
                            Text="Confirm"
                            Grid.Column="4"
                            Command="{Binding Source={x:Reference SubmitPageRoot}, Path=BindingContext.ConfirmOrderCommand}"
                            CommandParameter="{Binding}"
                            IsEnabled="{Binding CanConfirm}"
                            IsVisible="{Binding CanConfirm}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </VerticalStackLayout>
            </Border>


        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
