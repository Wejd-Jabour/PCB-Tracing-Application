<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="PCBTracker.UI.Views.CoordinatorPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:viewmodels="clr-namespace:PCBTracker.UI.ViewModels"
    x:Name="CoordinatorPageRoot"
    Title="Coordinator">

	<ContentPage.ToolbarItems>
		<!-- Manual sync button -->
		<ToolbarItem Text="Sync"
                     Command="{Binding RefreshCommand}" />
	</ContentPage.ToolbarItems>

	<ContentPage.Content>
		<Grid RowDefinitions="Auto,Auto,Auto,*"
              Padding="10"
              RowSpacing="8">

			<!-- Last sync label -->
			<Label Grid.Row="0"
                   Text="{Binding LastSyncLabel}"
                   FontSize="12"
                   TextColor="Gray" />

			<!-- Search box -->
			<Entry Grid.Row="1"
                   Placeholder="Search order #, inventory, PO"
                   Text="{Binding SearchText}"
                   ClearButtonVisibility="WhileEditing" />

			<!-- Processing status filter -->
			<Picker Grid.Row="2"
                    Title="Filter by processing status"
                    ItemsSource="{Binding ProcessingStatusOptions}"
                    SelectedItem="{Binding SelectedProcessingStatusFilter}" />

			<!-- Pull-to-refresh + list -->
			<RefreshView Grid.Row="3"
                         IsRefreshing="{Binding IsRefreshing}"
                         Command="{Binding RefreshCommand}">

				<CollectionView ItemsSource="{Binding Orders}"
                                Margin="0,6,0,0"
                                HorizontalOptions="FillAndExpand">

					<!-- Header row with field names -->
					<CollectionView.Header>
						<Border Stroke="LightGray"
                                StrokeThickness="1"
                                BackgroundColor="#EEF2F7"
                                Padding="6,4"
                                Margin="0,0,0,2"
                                HorizontalOptions="FillAndExpand">
							<!-- Star-sized columns so they stretch/shrink with the screen -->
							<Grid ColumnSpacing="8"
                                  HorizontalOptions="FillAndExpand"
                                  ColumnDefinitions="2*,4*,1*,1*,1.2*,1.2*,1.4*,1.4*,2.2*">

								<Label Grid.Column="0"
                                       Text="Order # / Status"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="1"
                                       Text="Inventory"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="2"
                                       Text="Qty"
                                       HorizontalTextAlignment="End"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="3"
                                       Text="Open"
                                       HorizontalTextAlignment="End"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="4"
                                       Text="PO"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="5"
                                       Text="Req"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="6"
                                       Text="Processing"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="7"
                                       Text="Updated"
                                       FontAttributes="Bold"
                                       FontSize="12" />
								<Label Grid.Column="8"
                                       Text="Change / Confirm"
                                       FontAttributes="Bold"
                                       FontSize="12"
                                       HorizontalOptions="Center"
                                       HorizontalTextAlignment="Center" />
							</Grid>
						</Border>
					</CollectionView.Header>

					<CollectionView.ItemTemplate>
						<DataTemplate>
							<!-- Row-style layout for each order -->
							<Border Stroke="LightGray"
                                    StrokeThickness="1"
                                    BackgroundColor="#FAFAFA"
                                    Margin="0,2"
                                    Padding="6,4"
                                    HorizontalOptions="FillAndExpand">
								<Grid ColumnSpacing="8"
                                      HorizontalOptions="FillAndExpand"
                                      VerticalOptions="Center"
                                      ColumnDefinitions="2*,4*,1*,1*,1.2*,1.2*,1.4*,1.4*,2.2*">

									<!-- Order # / Acumatica Status -->
									<VerticalStackLayout Grid.Column="0"
                                                         Spacing="2">
										<Label Text="{Binding OrderNbr}"
                                               FontAttributes="Bold"
                                               FontSize="13"
                                               LineBreakMode="TailTruncation" />
										<Label Text="{Binding Status}"
                                               FontSize="11"
                                               TextColor="Gray" />
									</VerticalStackLayout>

									<!-- Inventory -->
									<Label Grid.Column="1"
                                           Text="{Binding InventoryId}"
                                           FontSize="12"
                                           LineBreakMode="TailTruncation" />

									<!-- Qty -->
									<Label Grid.Column="2"
                                           Text="{Binding OrderQty, StringFormat='{}{0:0.##}'}"
                                           HorizontalTextAlignment="End"
                                           HorizontalOptions="End"
                                           FontSize="12" />

									<!-- Open -->
									<Label Grid.Column="3"
                                           Text="{Binding OpenQty, StringFormat='{}{0:0.##}'}"
                                           HorizontalTextAlignment="End"
                                           HorizontalOptions="End"
                                           FontSize="12" />

									<!-- PO -->
									<Label Grid.Column="4"
                                           Text="{Binding CustomerOrderNbr}"
                                           FontSize="12"
                                           LineBreakMode="TailTruncation" />

									<!-- Request date -->
									<Label Grid.Column="5"
                                           Text="{Binding RequestDate, StringFormat='{}{0:yyyy-MM-dd}'}"
                                           FontSize="11" />

									<!-- Current processing status (read-only display) -->
									<Label Grid.Column="6"
                                           Text="{Binding ProcessingStatus}"
                                           FontSize="11"
                                           FontAttributes="Bold" />

									<!-- Last updated -->
									<Label Grid.Column="7"
                                           Text="{Binding LastUpdatedAt, StringFormat='{}{0:yyyy-MM-dd}'}"
                                           FontSize="11"
                                           TextColor="Gray" />

									<!-- Dropdown + Confirm -->
									<HorizontalStackLayout Grid.Column="8"
                                                           Spacing="6"
                                                           HorizontalOptions="Center"
                                                           VerticalOptions="Center">

										<!-- Per-row processing status picker -->
										<Picker ItemsSource="{Binding BindingContext.RowProcessingStatusOptions, Source={x:Reference CoordinatorPageRoot}}"
                                                SelectedItem="{Binding ProcessingStatus}"
                                                MinimumWidthRequest="90" />

										<!-- Confirm button -->
										<Button Text="Confirm"
                                                FontSize="12"
                                                Padding="10,4"
                                                CornerRadius="12"
                                                HorizontalOptions="Center"
                                                MinimumWidthRequest="80"
                                                Command="{Binding BindingContext.ConfirmProcessingStatusCommand, Source={x:Reference CoordinatorPageRoot}}"
                                                CommandParameter="{Binding}" />
									</HorizontalStackLayout>
								</Grid>
							</Border>
						</DataTemplate>
					</CollectionView.ItemTemplate>
				</CollectionView>
			</RefreshView>
		</Grid>
	</ContentPage.Content>
</ContentPage>
